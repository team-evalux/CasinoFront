<div class="conteneur">
  <div class="slot-wrap">
    <h2 class="titre-page">ğŸ’ Mines (5Ã—5) â€” rÃ©vÃ©lation progressive</h2>

    <p class="sous-texte">
      <ng-container *ngIf="!isLoggedIn">ğŸŒ Mode invitÃ© â€” crÃ©dits fictifs â€¢ </ng-container>
      Solde : <strong>{{ currentBalance ?? 'â€”' }}</strong> â€¢
      Mise minimale : <strong>{{ minBet }}</strong>
    </p>

    <!-- Bandeau d'Ã©tat -->
    <div class="status-banner" *ngIf="sessionId && !finished">
      <ng-container *ngIf="safeCount === 0; else canCash">
        ğŸ¯ Partie en cours â€” clique une case pour commencer !
      </ng-container>
      <ng-template #canCash>
        âœ… Tu peux encaisser : <strong>{{ nextPayout }}</strong> crÃ©dits (Ã—{{ currentMultiplier || 1 }})
      </ng-template>
    </div>

    <div class="d-flex gap-12 mb-12 aic" style="flex-wrap:wrap;">

      <!-- Mise -->
      <div class="bloc">
        <label class="libelle">Mise</label>
        <div class="ligne">
          <input class="champ"
                 type="number"
                 [ngModel]="mise"
                 (ngModelChange)="onMiseChange($event)"
                 (keydown)="blockMiseKeys($event)"
                 [disabled]="!!sessionId"
                 [attr.min]="minBet"
                 [attr.max]="getMaxMise() || 0" />
          <button (click)="onMiseChange(Math.floor((mise||0)/2))"
                  [disabled]="!!sessionId">/2</button>
          <button (click)="onMiseChange((mise||0)*2)"
                  [disabled]="!!sessionId">Ã—2</button>
        </div>
        <small class="sous-texte">
          Mise min : <strong>{{ minBet }}</strong>
          â€¢ Mise max : <strong>{{ getMaxMise() || 0 }}</strong>
        </small>
      </div>

      <!-- Mines -->
      <div class="bloc">
        <label class="libelle">Mines</label>
        <div class="ligne">
          <input class="champ"
                 type="number"
                 [ngModel]="mines"
                 (ngModelChange)="onMinesChange($event)"
                 (keydown)="blockMinesKeys($event)"
                 [disabled]="!!sessionId"
                 min="1"
                 max="24" />
          <button (click)="onMinesChange(mines-1)"
                  [disabled]="!!sessionId">-</button>
          <button (click)="onMinesChange(mines+1)"
                  [disabled]="!!sessionId">+</button>
        </div>
        <small class="sous-texte">
          Diamants max possibles : <strong>{{ 25 - (mines||0) }}</strong>
        </small>
      </div>

      <!-- Boutons principaux -->
      <button class="bouton bouton--primaire" style="width:140px;"
              (click)="start()"
              [disabled]="!canStart()">
        {{ sessionId ? 'Partie en cours' : 'DÃ©marrer' }}
      </button>

      <button class="bouton bouton--secondaire btn-cashout"
              [class.btn-cashout-glow]="canCashout()"
              style="width:220px;"
              (click)="cashout()"
              [disabled]="!canCashout()">
        Encaisser
        <ng-container *ngIf="safeCount>0">
          â€” {{ nextPayout }} crÃ©dits (Ã—{{ currentMultiplier || 0 }})
        </ng-container>
      </button>

      <a [routerLink]="['/home']" class="bouton">Retour</a>
    </div>

    <p *ngIf="error" class="erreur">{{ error }}</p>

    <!-- Grille + overlay -->
    <div class="grid-wrap" [class.dimmed]="finished" [class.waiting]="!sessionId">
      <div class="grid"
           [class.disabled]="enCours"
           [class.ended]="finished">
        <button type="button"
                *ngFor="let idx of CELLS"
                class="cellule"
                [class.revelee]="revealed.has(idx)"
                [class.bomb]="revealed.has(idx) && bombs.has(idx)"
                (click)="canPick() && clickCell(idx)">
          <ng-container *ngIf="revealed.has(idx); else hidden">
            <span *ngIf="bombs.has(idx)">ğŸ’£</span>
            <span *ngIf="!bombs.has(idx)">ğŸ’</span>
          </ng-container>
          <ng-template #hidden> </ng-template>
        </button>
      </div>

      <!-- Overlay fin de partie -->
      <div class="grid-overlay" *ngIf="overlayVisible">
        <h3 class="overlay-title">{{ overlayTitle }}</h3>
        <p class="overlay-subtitle" *ngIf="overlaySubtitle">{{ overlaySubtitle }}</p>
        <div class="overlay-actions">
          <button class="bouton bouton--primaire" (click)="rejouer()">Rejouer</button>
          <a [routerLink]="['/home']" class="bouton">Retour</a>
        </div>
      </div>

      <!-- Aide quand aucune partie -->
      <div class="grid-overlay muted" *ngIf="!overlayVisible && !sessionId">
        <p>Clique sur <strong>DÃ©marrer</strong> pour lancer une partie.</p>
      </div>
    </div>

    <!-- RÃ¨gles -->
    <div class="panneau mt-12 regles-jeu">
      <h3 class="titre-regles">ğŸ¯ RÃ¨gles du jeu â€” Mines</h3>
      <ul class="liste-regles">
        <li>La grille contient <strong>25 cases</strong>. Tu choisis le nombre de <strong>mines</strong> entre 1 et 24.</li>
        <li>Plus il y a de mines, plus les <strong>multiplicateurs</strong> augmentent.</li>
        <li>Tu sÃ©lectionnes ta mise, puis tu cliques sur DÃ©marrer.</li>
        <li>Ã€ chaque clic :
          <br>â€¢ ğŸ’ = tu continues
          <br>â€¢ ğŸ’£ = tu perds la mise
        </li>
        <li>Tu peux encaisser aprÃ¨s avoir trouvÃ© au moins 1 diamant.</li>
      </ul>
    </div>

    <div class="panneau mt-12">
      <app-game-history-list [game]="'mines'" [limit]="5"></app-game-history-list>
    </div>
  </div>
</div>

<!-- âš  Popup sortie -->
<div class="leave-popup" *ngIf="showLeavePopup">
  <div class="leave-box">
    <h3>Attention</h3>
    <p>Votre mise risque d'Ãªtre perdue.<br>
      Voulez-vous vraiment quitter la partie ?</p>

    <div class="actions">
      <button class="btn-stay" (click)="cancelLeave()">Rester</button>
      <button class="btn-leave" (click)="confirmLeave()">Quitter</button>
    </div>
  </div>
</div>
