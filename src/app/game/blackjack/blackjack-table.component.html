<div class="bj-table pannel-like">
  <!-- HEADER -->
  <header class="bj-header" *ngIf="state as s">
    <div class="title-area">
      <h2 class="table-title">
        <span class="table-name">{{ s.name ? (s.name ) : '' }}</span>
      </h2>

      <div class="meta">
        <span class="meta-item">Phase: <strong>{{ s.phase }}</strong></span>
        <span class="meta-item" *ngIf="remainingSeconds > 0">â€¢ Temps: <strong>{{ remainingSeconds }}s</strong></span>
        <span class="meta-item" *ngIf="s.currentSeatIndex != null">â€¢ Actif: <strong>{{ s.currentSeatIndex }}</strong></span>
        <span class="meta-item you-turn" *ngIf="myTurn()">â€¢ C'est ton tour !</span>
      </div>
    </div>

    <div class="actions-area">
      <!-- RETOUR : mÃªme style que Fermer, sans <a> -->
      <button type="button"
              class="btn btn-close"
              (click)="goBack()"
              title="Retour au lobby">
        Retour
      </button>

      <button class="btn btn-close"
              *ngIf="s.creatorEmail === meEmail"
              (click)="closeTable()"
              [disabled]="s.phase !== 'BETTING'"
              [title]="s.phase !== 'BETTING' ? 'Attends la fin de la manche' : 'Fermer la table'">
        Fermer
      </button>
    </div>
  </header>

  <!-- Modal code privÃ© -->
  <div class="modal-backdrop" *ngIf="showCodeModal">
    <div class="modal">
      <h3>Table privÃ©e</h3>
      <p>Entre le code dâ€™accÃ¨s pour rejoindre la table.</p>

      <input
        [(ngModel)]="codeInput"
        (ngModelChange)="onCodeInputChange()"
        placeholder="Code dâ€™accÃ¨s"
        maxlength="20"
      />

      <div class="err" *ngIf="codeError">{{ codeError }}</div>

      <div class="row">
        <button class="btn btn-primary" (click)="submitCode()">Rejoindre</button>
        <a class="btn" [routerLink]="['/play/blackjack']">Annuler</a>
      </div>
    </div>
  </div>


  <!-- MAIN LAYOUT -->
  <main class="bj-main" *ngIf="state as s" [attr.aria-hidden]="showCodeModal ? true : null">
    <!-- LEFT : dealer + seats -->
    <section class="game-area">
      <div class="turn-banner" *ngIf="myTurn()">
        ğŸ¯ C'est Ã  toi de jouer !
      </div>

      <!-- RESULT TOAST -->
      <div *ngIf="s.phase === 'PAYOUT' && resultMessage" class="result-toast">
        {{ resultMessage }}
      </div>

      <!-- DEALER -->
      <div class="dealer-panel card-surface">
        <div class="dealer-head">
          <h3>Croupier</h3>
          <small class="dealer-total" *ngIf="s.phase !== 'PLAYING'">Total: {{ s.dealer.total }}</small>
          <small class="dealer-total" *ngIf="s.phase === 'PLAYING'">Total: ?</small>
        </div>

        <div class="dealer-cards">
          <ng-container *ngIf="s.phase === 'PLAYING'; else revealDealer">
            <img class="card-img" *ngIf="s.dealer.cards.length"
                 [src]="'assets/cards/' + cardFileName(s.dealer.cards[0])" alt="carte">
            <img class="card-img back" src="assets/cards/back.svg" alt="dos">
          </ng-container>

          <ng-template #revealDealer>
            <img class="card-img" *ngFor="let c of s.dealer.cards"
                 [src]="'assets/cards/' + cardFileName(c)" alt="carte">
          </ng-template>
        </div>
      </div>

      <!-- SEATS GRID -->
      <div class="seats-grid">
        <article class="seat-card" *ngFor="let seat of s.seats">
          <header class="seat-head">
            <div class="seat-title">
              <strong>SiÃ¨ge {{ seat.index }}</strong>
              <span class="seat-name" *ngIf="seat.displayName || seat.email">
                {{ seat.displayName ?? seat.email }}
              </span>
              <span class="seat-empty" *ngIf="!seat.displayName && !seat.email">Libre</span>
            </div>

            <div class="seat-badge" [ngClass]="{
              'badge-me': mySeat()?.index === seat.index,
              'badge-active': s.currentSeatIndex === seat.index,
              'badge-disconnected': seat.status === 'DISCONNECTED'
            }">
              <span *ngIf="seat.status">{{ seat.status }}</span>
            </div>
          </header>

          <div class="seat-cards" *ngIf="seat.hand.cards.length; else emptySlot">
            <img class="card-img" *ngFor="let c of seat.hand.cards"
                 [src]="'assets/cards/' + cardFileName(c)" alt="carte">
          </div>

          <ng-template #emptySlot>
            <div class="empty-slot">Aucune carte</div>
          </ng-template>

          <div class="seat-info">
            <div>Total: <strong>{{ seat.hand.total }}</strong></div>
            <div>Mise: <strong>{{ seat.hand.bet }}</strong></div>
          </div>

          <div class="seat-controls">
            <div *ngIf="mySeat()?.index === seat.index" class="btn-row">
              <button class="btn" (click)="hit()" [disabled]="!myTurn() || !(seat.hand.bet > 0)">Hit</button>
              <button class="btn" (click)="stand()" [disabled]="!myTurn() || !(seat.hand.bet > 0)">Stand</button>
              <button class="btn" (click)="double()" [disabled]="!myTurn() || !(seat.hand.bet > 0)">Double</button>
            </div>

            <!-- â›”ï¸ bouton â€œSâ€™asseoirâ€ supprimÃ© -->
          </div>
        </article>
      </div>
    </section>

    <!-- RIGHT : betting panel -->
    <aside class="controls-panel card-surface" *ngIf="state as s">
      <h4>Mise & contrÃ´les</h4>

      <div *ngIf="s.phase === 'BETTING' && mySeat() as me">

        <!-- Mise actuelle -->
        <div class="info-block" *ngIf="currentBet > 0" style="margin-bottom:6px;">
          Mise actuelle : <strong>{{ currentBet }}</strong> crÃ©dits
        </div>

        <!-- Champ -->
        <app-bet-input
          [(value)]="betAmount"
          [solde]="solde"
          [min]="s.minBet || 1"
          [max]="(s.maxBet && s.maxBet>0) ? s.maxBet : null"
          [label]="currentBet > 0 ? 'Ajouter Ã  la mise' : 'Ta mise'"
          (valueChange)="onBetInputChange()">
        </app-bet-input>

        <!-- Actions -->
        <div class="bet-actions" style="margin-top:8px;">
          <!-- PremiÃ¨re mise -->
          <button class="btn btn-primary"
                  *ngIf="currentBet === 0"
                  (click)="placeInitialBet()"
                  [disabled]="!canPlaceInitialBet(s)">
            Miser
          </button>

          <!-- AprÃ¨s une premiÃ¨re mise -->
          <ng-container *ngIf="currentBet > 0">
            <button class="btn btn-primary"
                    (click)="addToBet()"
                    [disabled]="!canAddToBet(s)">
              Ajouter
            </button>
            <button class="btn"
                    (click)="cancelBet()">
              Annuler
            </button>
          </ng-container>
        </div>

        <div class="limits" style="margin-top:6px;">
          Min/Max: <strong>{{ s.minBet || 0 }} / {{ s.maxBet && s.maxBet>0 ? s.maxBet : 'âˆ' }}</strong> â€”
          Solde: <strong>{{ solde }}</strong>
        </div>
      </div>

      <div *ngIf="s.phase !== 'BETTING'">
        <div class="info-block">
          <small>Phase: <strong>{{ s.phase }}</strong></small>
          <div *ngIf="s.deadline">Temps restant: <strong>{{ remainingSeconds }}s</strong></div>
        </div>
      </div>

      <div class="table-stats">
        <h5>Table</h5>
        <div>SiÃ¨ges: <strong>{{ s.maxSeats }}</strong></div>
        <div>Min/Max: <strong>{{ s.minBet || 0 }} / {{ s.maxBet && s.maxBet>0 ? s.maxBet : 'âˆ' }}</strong></div>
        <div>CrÃ©ateur: <strong>{{ s.creatorDisplayName ?? s.creatorEmail ?? '-' }}</strong></div>
      </div>
    </aside>
  </main>

  <!-- ====== RÃ¨gles du jeu : Blackjack ====== -->
  <div class="panneau mt-12 regles-jeu">
    <h3 class="titre-regles">ğŸƒ RÃ¨gles du jeu â€” Blackjack</h3>

    <ul class="liste-regles">
      <li>Le but du jeu est dâ€™obtenir une main plus proche de <strong>21</strong> que celle du croupier, sans le dÃ©passer.</li>
      <li><strong>Valeurs des cartes :</strong>
        <ul>
          <li>2 Ã  10 â†’ leur valeur nominale</li>
          <li>Valet, Dame, Roi â†’ 10</li>
          <li>As â†’ 1 ou 11 (selon la meilleure main possible)</li>
        </ul>
      </li>
      <li><strong>DÃ©roulement :</strong>
        <ul>
          <li>Chaque joueur place sa mise pendant la phase <em>BETTING</em>.</li>
          <li>Le croupier distribue 2 cartes Ã  chaque joueur et 2 Ã  lui-mÃªme (une cachÃ©e).</li>
          <li>Ã€ ton tour :
            <ul>
              <li><strong>Hit</strong> â†’ tirer une carte</li>
              <li><strong>Stand</strong> â†’ rester sur ton total</li>
              <li><strong>Double</strong> â†’ doubler la mise, tirer une carte, puis passer</li>
            </ul>
          </li>
          <li>Si tu dÃ©passes 21 â†’ <strong>Bust</strong> (tu perds ta mise)</li>
          <li>Le croupier tire jusquâ€™Ã  au moins 17 points.</li>
        </ul>
      </li>
      <li><strong>Gains :</strong>
        <ul>
          <li>Blackjack (As + 10/Valet/Dame/Roi) â†’ <strong>Ã—1.5</strong> la mise</li>
          <li>Victoire normale â†’ <strong>Ã—2</strong></li>
          <li>Ã‰galitÃ© â†’ mise rendue</li>
          <li>Perte â†’ mise perdue</li>
        </ul>
      </li>
    </ul>

    <div class="note-regle">
      ğŸ’¡ Exemple : tu mises <strong>200 crÃ©dits</strong>. Tu fais un Blackjack â†’ tu gagnes <strong>300 crÃ©dits</strong> (gain net +100).
    </div>
  </div>

  <!-- cache l'historique quand la modale code est ouverte -->
  <div class="panneau mt-12" *ngIf="!showCodeModal">
    <app-game-history-list [game]="'blackjack'" [limit]="5"></app-game-history-list>
  </div>

</div>
