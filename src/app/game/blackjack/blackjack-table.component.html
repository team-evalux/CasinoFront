<!-- blackjack-table.component.html -->
<div class="bj-table pannel-like">
  <!-- HEADER -->
  <header class="bj-header" *ngIf="state as s">
    <div class="title-area">
      <h2 class="table-title">
        <span class="muted">Table</span>
        <span class="table-name">{{ s.name ? (s.name + ' — ') : '' }}</span>
        <span class="table-id">{{ s.id }}</span>
      </h2>

      <div class="meta">
        <span class="meta-item">Phase: <strong>{{ s.phase }}</strong></span>
        <span class="meta-item" *ngIf="remainingSeconds > 0">• Temps: <strong>{{ remainingSeconds }}s</strong></span>
        <span class="meta-item" *ngIf="s.currentSeatIndex != null">• Actif: <strong>{{ s.currentSeatIndex }}</strong></span>
        <span class="meta-item you-turn" *ngIf="myTurn()">• C'est ton tour !</span>
      </div>
    </div>

    <div class="actions-area">
      <button class="btn btn-close"
              *ngIf="s.creatorEmail === meEmail"
              (click)="closeTable()"
              [disabled]="s.phase !== 'BETTING'"
              [title]="s.phase !== 'BETTING' ? 'Attends la fin de la manche' : 'Fermer la table'">
        Fermer
      </button>
    </div>
  </header>

  <!-- MAIN LAYOUT : left = game area, right = betting/controls -->
  <main class="bj-main" *ngIf="state as s">
    <!-- LEFT : dealer + seats -->
    <section class="game-area">
      <!-- RESULT TOAST -->
      <div *ngIf="s.phase === 'PAYOUT' && resultMessage" class="result-toast">
        {{ resultMessage }}
      </div>

      <!-- DEALER -->
      <div class="dealer-panel card-surface">
        <div class="dealer-head">
          <h3>Croupier</h3>
          <small class="dealer-total" *ngIf="s.phase !== 'PLAYING'">Total: {{ s.dealer.total }}</small>
          <small class="dealer-total" *ngIf="s.phase === 'PLAYING'">Total: ?</small>
        </div>

        <div class="dealer-cards">
          <ng-container *ngIf="s.phase === 'PLAYING'; else revealDealer">
            <img class="card-img" *ngIf="s.dealer.cards.length"
                 [src]="'assets/cards/' + cardFileName(s.dealer.cards[0])" alt="carte">
            <img class="card-img back" src="assets/cards/back.svg" alt="dos">
          </ng-container>

          <ng-template #revealDealer>
            <img class="card-img" *ngFor="let c of s.dealer.cards"
                 [src]="'assets/cards/' + cardFileName(c)" alt="carte">
          </ng-template>
        </div>
      </div>

      <!-- SEATS GRID -->
      <div class="seats-grid">
        <article class="seat-card" *ngFor="let seat of s.seats">
          <header class="seat-head">
            <div class="seat-title">
              <strong>Siège {{ seat.index }}</strong>
              <span class="seat-name" *ngIf="seat.displayName || seat.email">
                  {{ seat.displayName ?? seat.email }}
              </span>
              <span class="seat-empty" *ngIf="!seat.displayName && !seat.email">Libre</span>

            </div>

            <div class="seat-badge" [ngClass]="{
              'badge-me': mySeat()?.index === seat.index,
              'badge-active': s.currentSeatIndex === seat.index,
              'badge-disconnected': seat.status === 'DISCONNECTED'
            }">
              <span *ngIf="seat.status">{{ seat.status }}</span>
            </div>
          </header>

          <div class="seat-cards" *ngIf="seat.hand.cards.length; else emptySlot">
            <img class="card-img" *ngFor="let c of seat.hand.cards"
                 [src]="'assets/cards/' + cardFileName(c)" alt="carte">
          </div>

          <ng-template #emptySlot>
            <div class="empty-slot">Aucune carte</div>
          </ng-template>

          <div class="seat-info">
            <div>Total: <strong>{{ seat.hand.total }}</strong></div>
            <div>Mise: <strong>{{ seat.hand.bet }}</strong></div>
          </div>

          <div class="seat-controls">
            <div *ngIf="mySeat()?.index === seat.index" class="btn-row">
              <!-- normalise bet checks avec nullish coalescing pour satisfaire strictTemplates -->
              <button class="btn" (click)="hit()" [disabled]="!myTurn() || !(seat.hand.bet > 0)">Hit</button>
              <button class="btn" (click)="stand()" [disabled]="!myTurn() || !(seat.hand.bet > 0)">Stand</button>
              <button class="btn" (click)="double()" [disabled]="!myTurn() || !(seat.hand.bet > 0)">Double</button>
              <button class="btn" (click)="surrender()" [disabled]="!myTurn() || !(seat.hand.bet > 0)">Surrender</button>
            </div>

            <div *ngIf="!seat.email && !mySeat()" class="sit-row">
              <button class="btn btn-primary" (click)="sit(seat.index)">S’asseoir</button>
            </div>
          </div>
        </article>
      </div>
    </section>

    <!-- RIGHT : betting + helper -->
    <aside class="controls-panel card-surface">
      <h4>Mise & contrôles</h4>

      <div *ngIf="s.phase === 'BETTING' && mySeat() as me" class="bet-box">
        <label class="label">Ta mise</label>
        <input class="champ" type="number"
               [(ngModel)]="betAmount"
               (ngModelChange)="onBetInputChange()"
               [min]="s.minBet || 1"
               [max]="(s.maxBet && s.maxBet>0) ? s.maxBet : null"
               [placeholder]="s.minBet ? ('Mise (' + s.minBet + '–' + (s.maxBet && s.maxBet>0 ? s.maxBet : '∞') + ')') : 'Mise'">

        <div class="bet-actions">
          <button class="btn btn-primary" (click)="bet()" [disabled]="!canPlaceBet(s)">Miser</button>
          <!--          <button class="btn" (click)="leave()" [disabled]="!mySeat()">Quitter</button>-->
        </div>

        <small class="limits" *ngIf="s.minBet || s.maxBet">Limites : min={{ s.minBet || 0 }} <span *ngIf="s.maxBet && s.maxBet>0">• max={{ s.maxBet }}</span></small>
      </div>

      <div *ngIf="s.phase !== 'BETTING'">
        <div class="info-block">
          <small>Phase: <strong>{{ s.phase }}</strong></small>
          <div *ngIf="s.deadline">Temps restant: <strong>{{ remainingSeconds }}s</strong></div>
        </div>
      </div>

      <div class="table-stats">
        <h5>Table</h5>
        <div>Sièges: <strong>{{ s.maxSeats }}</strong></div>
        <div>Min/Max: <strong>{{ s.minBet || 0 }} / {{ s.maxBet && s.maxBet>0 ? s.maxBet : '∞' }}</strong></div>
        <div>Créateur: <strong>{{ s.creatorDisplayName ?? s.creatorEmail ?? '-' }}</strong></div>
      </div>
    </aside>
  </main>

  <!-- LOADING / ERROR -->
  <!--  <ng-template #loadingBlock>-->
  <!--    <div class="loading-block">-->
  <!--      <p *ngIf="!state && !error">Chargement…</p>-->
  <!--      <p *ngIf="error" class="err">{{ error }}</p>-->
  <!--    </div>-->
  <!--  </ng-template>-->
</div>
