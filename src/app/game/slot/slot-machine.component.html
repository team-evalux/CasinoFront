<div class="conteneur">
  <div class="slot-wrap">
    <h2 class="titre-page">Machine Ã  sous</h2>

    <p class="sous-texte">
      Solde : <strong>{{ currentBalance ?? 'â€”' }}</strong> â€¢
      Mise minimale : <strong>{{ minBet }}</strong> â€¢
      Machine chargÃ©e : <strong>{{ reelsCount }} rouleaux</strong>
    </p>

    <div class="d-flex aic gap-12 mb-12" style="flex-wrap:wrap;">
      <div style="min-width:180px;">
        <label class="libelle">Mise (crÃ©dits)</label>
        <div style="display:flex; align-items:center; gap:6px;">
          <input class="champ" type="number"
                 [(ngModel)]="mise"
                 [attr.min]="minBet"
                 [attr.max]="currentBalance || 1000000"
                 [disabled]="!isLoggedIn || enCours"/>
          <button type="button"
                  (click)="mise = Math.min((mise || 0) * 2, currentBalance || 1000000)"
                  [disabled]="!isLoggedIn || enCours">Ã—2</button>
          <button type="button"
                  (click)="mise = Math.max(Math.floor((mise || 0) / 2), minBet)"
                  [disabled]="!isLoggedIn || enCours">/2</button>
        </div>
        <small class="sous-texte">
          Mise minimale : <strong>{{ minBet }}</strong> â€¢ Solde : <strong>{{ currentBalance ?? 'â€”' }}</strong>
        </small>
        <small *ngIf="currentBalance !== null && mise > currentBalance" style="display:block;color:#ff9b9b;">
          La mise ne peut pas dÃ©passer votre solde ({{ currentBalance }} crÃ©dits).
        </small>
      </div>

      <button (click)="jouer()" [disabled]="!isLoggedIn || enCours" class="bouton bouton--primaire" style="width:120px;">
        {{ enCours ? 'Spinningâ€¦' : 'Spin' }}
      </button>

      <div class="d-flex aic gap-8">
        <label class="libelle" style="margin:0;">Autospins</label>
        <input class="champ" type="number" [(ngModel)]="autoSpinCount" min="0" title="0 = infini" style="width:90px;" [disabled]="!isLoggedIn || enCours">
        <button (click)="startAutoSpin()" [disabled]="!isLoggedIn || autoSpinActive || (currentBalance!=null && mise>currentBalance)" class="bouton">Auto-Spin</button>
        <button (click)="stopAutoSpin()" [disabled]="!isLoggedIn || !autoSpinActive" class="bouton bouton--secondaire">Stop</button>
      </div>

      <div style="min-width:180px;">
        <label class="libelle">Nombre rouleaux</label>
        <select [(ngModel)]="desiredReelsCount"
                (change)="setDesiredReels(desiredReelsCount)"
                [disabled]="enCours || autoSpinActive">
          <option *ngFor="let n of [3,4,5]" [ngValue]="n">{{n}} rouleaux</option>
        </select>
      </div>

      <a [routerLink]="['/home']" class="bouton">Retour</a>

      <div *ngIf="autoSpinActive" class="solde-chip">
        {{ remainingAutoSpins != null ? ('Restant: ' + remainingAutoSpins) : 'Auto : infini' }}
      </div>
    </div>

    <!-- Reels -->
    <div class="reels-area" [class.disabled]="enCours" style="position:relative;">
      <div class="reel" *ngFor="let reel of reels; let ri = index">
        <div class="strip" #reelStrip>
          <div class="cell" *ngFor="let s of reel.sequence">{{ s }}</div>
        </div>
        <div class="mask"></div>
      </div>

      <div *ngIf="!isLoggedIn" class="lock-overlay">
        <div class="lock">ğŸ”’</div>
        <div>Connecte-toi pour lancer un spin</div>
        <a routerLink="/login" class="cta">Se connecter</a>
      </div>
    </div>

    <div *ngIf="lastResult" class="panneau mt-12">
      <div class="final-row d-flex gap-12" style="justify-content:center; margin-bottom:8px;">
        <div *ngFor="let s of lastResult.reels" class="final-cell" style="font-size:36px;min-width:64px;text-align:center;">{{ s }}</div>
      </div>

      <ng-container [ngSwitch]="true">
        <p *ngSwitchCase="netGain > 0" style="color:#34d399;margin:0;">Tu as gagnÃ© ! <strong>{{ netLabel }}</strong> crÃ©dits.</p>
        <p *ngSwitchCase="netGain === 0" style="color:#eab308;margin:0;">Tu rÃ©cupÃ¨res ta mise. <strong>0</strong> crÃ©dit net.</p>
        <p *ngSwitchDefault style="color:#f87171;margin:0;">Tu as perdu. <strong>{{ netLabel }}</strong> crÃ©dits.</p>
      </ng-container>

      <p class="mt-8">Solde : <strong>{{ lastResult.solde }}</strong></p>
    </div>

    <!-- ====== RÃ¨gles du jeu : Machine Ã  sous ====== -->
    <div class="panneau mt-12 regles-jeu">
      <h3 class="titre-regles">ğŸ° RÃ¨gles du jeu â€” Machine Ã  sous</h3>

      <ul class="liste-regles">
        <li>La <strong>mise minimale</strong> est de <strong>{{ minBet }}</strong> crÃ©dits.</li>
        <li>Choisis le <strong>nombre de rouleaux</strong> (3, 4 ou 5) avant de lancer la machine.</li>

        <li><strong>Symbole & valeur de base :</strong>
          <ul>
            <li>ğŸ’ Cerise â†’ 1.0</li>
            <li>ğŸ‹ Citron â†’ 1.3 (3R) / 1.4 (4R) / 1.3 (5R)</li>
            <li>ğŸŠ Orange â†’ 1.0 (3R) / 2.2 (4R) / 1.7 (5R)</li>
            <li>â­ Ã‰toile â†’ 1.1 (3R) / 3.1 (4R) / 2.4 (5R)</li>
            <li>7ï¸âƒ£ Sept â†’ 1.3 (3R) / 4.0 (4R) / 3.0 (5R)</li>
          </ul>
        </li>

        <li><strong>Multiplicateurs selon combinaisons :</strong>
          <ul>
            <li><strong>3 rouleaux :</strong> 3 identiques = Ã—6 â€¢ 2 identiques = Ã—1</li>
            <li><strong>4 rouleaux :</strong> 4 identiques = Ã—6 â€¢ 3 identiques = Ã—3</li>
            <li><strong>5 rouleaux :</strong> 5 identiques = Ã—10 â€¢ 4 identiques = Ã—5 â€¢ 3 identiques = Ã—1</li>
          </ul>
        </li>

        <li>Les gains sont calculÃ©s en fonction de la valeur du symbole Ã— multiplicateur Ã— mise.</li>
        <li>Si aucune combinaison nâ€™est gagnante, la mise est perdue.</li>
      </ul>

      <div class="note-regle">
        ğŸ’¡ Exemple : tu mises <strong>100 crÃ©dits</strong> sur une machine Ã  4 rouleaux et tu obtiens 4 ğŸŠ.
        â†’ Valeur orange = 2.2 â€¢ Multiplicateur = 6 â†’ Gain = <strong>100 Ã— 2.2 Ã— 6 = 1320 crÃ©dits</strong>.
      </div>
    </div>
    <div class="panneau mt-12">
      <app-game-history-list [game]="'slots'" [limit]="5"></app-game-history-list>
    </div>
  </div>
</div>
