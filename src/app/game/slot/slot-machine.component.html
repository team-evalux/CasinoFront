<!-- src/app/games/slot-machine/slot-machine.component.html -->
<div class="conteneur">
  <div class="slot-wrap">
    <h2 class="titre-page">Machine Ã  sous</h2>

    <!-- âœ… prÃ©ciser la machine actuellement chargÃ©e -->
    <p class="sous-texte">
      Solde : <strong>{{ currentBalance ?? 'â€”' }}</strong> â€¢
      Mise minimale : <strong>{{ minBet }}</strong> â€¢
      Machine chargÃ©e : <strong>{{ reelsCount }} rouleaux</strong>
    </p>

    <div class="d-flex aic gap-12 mb-12" style="flex-wrap:wrap;">
      <div style="min-width:180px;">
        <label class="libelle">Mise (crÃ©dits)</label>
        <div style="display:flex; align-items:center; gap:6px;">
          <input class="champ" type="number"
                 [(ngModel)]="mise"
                 [attr.min]="minBet"
                 [attr.max]="currentBalance || 1000000"
                 [disabled]="!isLoggedIn || enCours"/>
          <button type="button"
                  (click)="mise = Math.min((mise || 0) * 2, currentBalance || 1000000)"
                  [disabled]="!isLoggedIn || enCours">Ã—2</button>
          <button type="button"
                  (click)="mise = Math.max(Math.floor((mise || 0) / 2), minBet)"
                  [disabled]="!isLoggedIn || enCours">/2</button>
        </div>
        <small class="sous-texte">Mise minimale : <strong>{{ minBet }}</strong> â€¢ Solde : <strong>{{ currentBalance ?? 'â€”' }}</strong></small>
      </div>


      <button (click)="jouer()" [disabled]="!isLoggedIn || enCours" class="bouton bouton--primaire" style="width:120px;">
        {{ enCours ? 'Spinningâ€¦' : 'Spin' }}
      </button>

      <div class="d-flex aic gap-8">
        <label class="libelle" style="margin:0;">Autospins</label>
        <input class="champ" type="number" [(ngModel)]="autoSpinCount" min="0" title="0 = infini" style="width:90px;" [disabled]="!isLoggedIn || enCours">
        <button (click)="startAutoSpin()" [disabled]="!isLoggedIn || autoSpinActive || (currentBalance!=null && mise>currentBalance)" class="bouton">Auto-Spin</button>
        <button (click)="stopAutoSpin()" [disabled]="!isLoggedIn || !autoSpinActive" class="bouton bouton--secondaire">Stop</button>
      </div>

      <!-- âœ… choix machine par lâ€™utilisateur ; on bloque pendant le spin/auto-spin -->
      <div style="min-width:180px;">
        <label class="libelle">Nombre rouleaux</label>
        <select [(ngModel)]="desiredReelsCount"
                (change)="setDesiredReels(desiredReelsCount)"
                [disabled]="enCours || autoSpinActive">
          <option *ngFor="let n of [3,4,5]" [ngValue]="n">{{n}} rouleaux</option>
        </select>
      </div>

      <a [routerLink]="['/home']" class="bouton">Retour</a>

      <div *ngIf="autoSpinActive" class="solde-chip">
        {{ remainingAutoSpins != null ? ('Restant: ' + remainingAutoSpins) : 'Auto : infini' }}
      </div>
    </div>

    <!-- Reels -->
    <div class="reels-area" [class.disabled]="enCours" style="position:relative;">
      <div class="reel" *ngFor="let reel of reels; let ri = index">
        <div class="strip" #reelStrip>
          <div class="cell" *ngFor="let s of reel.sequence">{{ s }}</div>
        </div>
        <div class="mask"></div>
      </div>

      <div *ngIf="!isLoggedIn" class="lock-overlay">
        <div class="lock">ðŸ”’</div>
        <div>Connecte-toi pour lancer un spin</div>
        <a routerLink="/login" class="cta">Se connecter</a>
      </div>
    </div>

    <div *ngIf="lastResult" class="panneau mt-12">
      <div class="final-row d-flex gap-12" style="justify-content:center; margin-bottom:8px;">
        <div *ngFor="let s of lastResult.reels" class="final-cell" style="font-size:36px;min-width:64px;text-align:center;">{{ s }}</div>
      </div>

      <p *ngIf="lastResult.win" style="color:#34d399;margin:0;">Tu as gagnÃ© ! +<strong>{{ lastResult.montantGagne }}</strong> crÃ©dits.</p>
      <p *ngIf="!lastResult.win" style="color:#f87171;margin:0;">Tu as perdu. -<strong>{{ lastResult.montantJoue }}</strong> crÃ©dits.</p>
      <p class="mt-8">Solde : <strong>{{ lastResult.solde }}</strong></p>
    </div>

    <p *ngIf="error" style="color:#ff9b9b" class="mt-12">{{ error }}</p>

    <div class="mt-16 sous-texte">
      <small>Machine visuelle adaptative â€” la config est rechargÃ©e selon le nombre de rouleaux choisi.</small>
    </div>
  </div>

  <div class="panneau mt-12">
    <app-game-history-list [game]="'slots'" [limit]="5"></app-game-history-list>
  </div>
</div>
